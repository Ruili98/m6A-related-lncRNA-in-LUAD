#install.packages('survival')


options(stringsAsFactors=F)
library(survival)          #Cite package
setwd("D:\\m6A related lncRNA+SNP+ GIlncRNA\\model\\Indep")        #set dir

#Define an independent prognostic analysis function
indep=function(riskFile=null, cliFile=null, uniOutFile=null, multiOutFile=null){
	risk=read.table(riskFile, header=T, sep="\t", check.names=F, row.names=1)    #Read risk file
	cli=read.table(cliFile, header=T, sep="\t", check.names=F, row.names=1)      #Read clinical data
	
	#Merge data
	sameSample=intersect(row.names(cli),row.names(risk))
	risk=risk[sameSample,]
	cli=cli[sameSample,]
	rt=cbind(futime=risk[,1], fustat=risk[,2], cli, riskScore=risk[,(ncol(risk)-1)])
	
	#Univariate independent prognostic analysis
	uniTab=data.frame()
	for(i in colnames(rt[,3:ncol(rt)])){
		 cox <- coxph(Surv(futime, fustat) ~ rt[,i], data = rt)
		 coxSummary = summary(cox)
		 uniTab=rbind(uniTab,
		              cbind(id=i,
		              HR=coxSummary$conf.int[,"exp(coef)"],
		              HR.95L=coxSummary$conf.int[,"lower .95"],
		              HR.95H=coxSummary$conf.int[,"upper .95"],
		              pvalue=coxSummary$coefficients[,"Pr(>|z|)"])
		              )
	}
	write.table(uniTab,file=uniOutFile,sep="\t",row.names=F,quote=F)
	
	
	#Multivariate independent prognostic analysis
	uniTab=uniTab[as.numeric(uniTab[,"pvalue"])<0.05,]
	rt1=rt[,c("futime","fustat",as.vector(uniTab[,"id"]))]
	multiCox=coxph(Surv(futime, fustat) ~ ., data = rt1)
	multiCoxSum=summary(multiCox)
	multiTab=data.frame()
	multiTab=cbind(
	             HR=multiCoxSum$conf.int[,"exp(coef)"],
	             HR.95L=multiCoxSum$conf.int[,"lower .95"],
	             HR.95H=multiCoxSum$conf.int[,"upper .95"],
	             pvalue=multiCoxSum$coefficients[,"Pr(>|z|)"])
	multiTab=cbind(id=row.names(multiTab),multiTab)
	write.table(multiTab,file=multiOutFile,sep="\t",row.names=F,quote=F)
}

#Independent prognostic analysis
indep(riskFile="trainingRisk.txt", cliFile="clinical.txt", uniOutFile="training.uniCox.txt", multiOutFile="training.multiCox.txt")
indep(riskFile="testingRisk.txt", cliFile="clinical.txt", uniOutFile="testing.uniCox.txt", multiOutFile="testing.multiCox.txt")
indep(riskFile="allRisk.txt", cliFile="clinical.txt", uniOutFile="all.uniCox.txt", multiOutFile="all.multiCox.txt")



